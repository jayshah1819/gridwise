<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Gridwise’s Buffer Class | Gridwise</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Gridwise’s Buffer Class" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Explore the Buffer class that encapsulates data spanning CPU and GPU with consistent typed arrays and GPUBuffers." />
<meta property="og:description" content="Explore the Buffer class that encapsulates data spanning CPU and GPU with consistent typed arrays and GPUBuffers." />
<link rel="canonical" href="http://localhost:4000/gridwise/docs/2025/09/16/buffer/" />
<meta property="og:url" content="http://localhost:4000/gridwise/docs/2025/09/16/buffer/" />
<meta property="og:site_name" content="Gridwise" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-09-16T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gridwise’s Buffer Class" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-09-16T00:00:00-04:00","datePublished":"2025-09-16T00:00:00-04:00","description":"Explore the Buffer class that encapsulates data spanning CPU and GPU with consistent typed arrays and GPUBuffers.","headline":"Gridwise’s Buffer Class","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/gridwise/docs/2025/09/16/buffer/"},"url":"http://localhost:4000/gridwise/docs/2025/09/16/buffer/"}</script>
<!-- End Jekyll SEO tag -->
<link id="main-stylesheet" rel="stylesheet" href="/gridwise/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/gridwise/feed.xml" title="Gridwise" />
</head>
<body><header class="site-header">

  <div class="wrapper">
    <a class="site-title" rel="author" href="/gridwise/">Gridwise</a>
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon"></span>
        </label>

        <div class="nav-items">
  <a class="nav-item" href="/gridwise/about/">About</a>
  <a class="nav-item" href="/gridwise/gridwise/architecture/">Gridwise Architecture</a>
  <a class="nav-item" href="/gridwise/gridwise/binop/">Gridwise&#39;s Binary Operator Class</a>
  <a class="nav-item" href="/gridwise/gridwise/buffer/">Gridwise&#39;s Buffer Class</a>
  <a class="nav-item" href="/gridwise/gridwise/builtins-strategy/">Gridwise WebGPU @builtins Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/">Gridwise</a>
  <a class="nav-item" href="/gridwise/gridwise/primitive-design/">Gridwise WebGPU Primitive Strategy wrt Subgroups</a>
  <a class="nav-item" href="/gridwise/gridwise/scan-and-reduce/">Gridwise Scan and Reduce</a>
  <a class="nav-item" href="/gridwise/gridwise/sort/">Gridwise Sort</a>
  <a class="nav-item" href="/gridwise/gridwise/subgroup-strategy/">Gridwise WebGPU Subgroup Emulation Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/timing-strategy/">Gridwise WebGPU Timing Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/webgpu-object-caching-strategy/">Gridwise WebGPU Object Caching Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/writing-a-webgpu-wgsl-workgroup-reduce-function/">Abstraction Challenges in Writing a WebGPU/WGSL Workgroup Reduce Function</a>
</div>

      </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Gridwise&#39;s Buffer Class</h1>
    <div class="post-meta">
      <time class="dt-published" datetime="2025-09-16T00:00:00-04:00" itemprop="datePublished">
        Sep 16, 2025
      </time>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>During Gridwise’s development, we found a need to encapsulate the concept of a single wad of data that spans CPU and GPU. We call this class <code class="language-plaintext highlighter-rouge">Buffer</code>. It contains both a CPU-side JS typed array and a GPU-side <code class="language-plaintext highlighter-rouge">GPUBuffer</code>. The abstraction is that these two objects are (roughly) consistent with each other (they are not meant to store two logically different objects).</p>

<p>We believe this is an object whose design could be revisited and improved, because it is generally useful in WebGPU primitive development and more generally across WebGPU development. We welcome a redesign. For that purpose, we list our use cases:</p>

<ul>
  <li>We want to couple CPU and GPU buffers that store the same logical data as one logical entity (here, a <code class="language-plaintext highlighter-rouge">Buffer</code> class). The class should be able to copy data between them easily.
    <ul>
      <li>On the CPU side, we want to use a JavaScript typed array.</li>
      <li>On the GPU side, we want to use a WebGPU <code class="language-plaintext highlighter-rouge">GPUBuffer</code>. We note a <code class="language-plaintext highlighter-rouge">GPUBuffer</code> can be a subset of a GPU-side allocation.</li>
    </ul>
  </li>
  <li>We want to allow initializing this <code class="language-plaintext highlighter-rouge">Buffer</code> in multiple flexible ways. For instance, we should be able to initialize a <code class="language-plaintext highlighter-rouge">Buffer</code> using an existing <code class="language-plaintext highlighter-rouge">GPUBuffer</code>, or alternatively ask the <code class="language-plaintext highlighter-rouge">Buffer</code> constructor to allocate one.</li>
  <li>We need to generate data on the CPU for testing, storing it in the (CPU) buffer. We wish to support different methods for data generation (for instance, random numbers within a range, or a dataset where <code class="language-plaintext highlighter-rouge">buffer[i] = i</code>).</li>
  <li>We want to hide WebGPU details if possible (for instance, the call to create a <code class="language-plaintext highlighter-rouge">GPUBuffer</code>, the call to copy data between CPU and GPU).</li>
  <li>The <code class="language-plaintext highlighter-rouge">Buffer</code> needs a label so it can be associated with Gridwise primitives.</li>
  <li>At least one of our primitives (sort) writes its GPU output on top of its GPU input. A <code class="language-plaintext highlighter-rouge">Buffer</code> class must support this and additionally store the original (CPU) input for correctness validation.</li>
  <li>We want to support querying a <code class="language-plaintext highlighter-rouge">Buffer</code> for both:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">size</code> (the number of bytes in the buffer)</li>
      <li><code class="language-plaintext highlighter-rouge">length</code> (the number of elements in the buffer)</li>
    </ul>
  </li>
</ul>

<h2 id="buffer-class-documentation"><code class="language-plaintext highlighter-rouge">Buffer</code> Class documentation</h2>

<h2 id="constructor">Constructor</h2>

<h3 id="constructorargs"><code class="language-plaintext highlighter-rouge">constructor(args)</code></h3>

<p>This creates a new <code class="language-plaintext highlighter-rouge">Buffer</code> instance, using the properties of the <strong><code class="language-plaintext highlighter-rouge">args</code></strong> object to configure the buffer.</p>

<p><strong>Arguments:</strong></p>

<p>The constructor takes a single <strong><code class="language-plaintext highlighter-rouge">args</code></strong> object with these optional properties:</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">label</code></strong>: <code class="language-plaintext highlighter-rouge">string</code> - A descriptive name for the buffer.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">device</code></strong>: <code class="language-plaintext highlighter-rouge">GPUDevice</code> - <strong>(Required)</strong> The WebGPU device used to create the buffer.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">datatype</code></strong>: <code class="language-plaintext highlighter-rouge">string</code> - <strong>(Required)</strong> The data type of elements in the buffer (e.g., <code class="language-plaintext highlighter-rouge">'f32'</code>, <code class="language-plaintext highlighter-rouge">'u32'</code>, <code class="language-plaintext highlighter-rouge">'i32'</code>).</li>
  <li><strong><code class="language-plaintext highlighter-rouge">size</code></strong>: <code class="language-plaintext highlighter-rouge">number</code> - The buffer’s total size in bytes. You must specify either <strong><code class="language-plaintext highlighter-rouge">size</code></strong> or <strong><code class="language-plaintext highlighter-rouge">length</code></strong>, but not both.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">length</code></strong>: <code class="language-plaintext highlighter-rouge">number</code> - The number of elements in the buffer.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">usage</code></strong>: <code class="language-plaintext highlighter-rouge">GPUBufferUsageFlags</code> - Specifies how the GPU buffer will be used. It defaults to <code class="language-plaintext highlighter-rouge">GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC | GPUBufferUsage.COPY_DST</code>.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">buffer</code></strong>: <code class="language-plaintext highlighter-rouge">GPUBuffer</code> or <code class="language-plaintext highlighter-rouge">GPUBufferBinding</code> - An existing buffer to wrap. If you provide this, <strong><code class="language-plaintext highlighter-rouge">createGPUBuffer</code></strong> should be <code class="language-plaintext highlighter-rouge">false</code>.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">createCPUBuffer</code></strong>: <code class="language-plaintext highlighter-rouge">boolean</code> - If <code class="language-plaintext highlighter-rouge">true</code>, a CPU-side <code class="language-plaintext highlighter-rouge">TypedArray</code> is created.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">initializeCPUBuffer</code></strong>: <code class="language-plaintext highlighter-rouge">string</code> - A keyword specifying how to fill the CPU buffer with initial data.
    <ul>
      <li>For floats (<code class="language-plaintext highlighter-rouge">'f32'</code>): <code class="language-plaintext highlighter-rouge">'randomizeMinusOneToOne'</code>, <code class="language-plaintext highlighter-rouge">'randomizeAbsUnder1024'</code>, <code class="language-plaintext highlighter-rouge">'fisher-yates'</code>.</li>
      <li>For integers (<code class="language-plaintext highlighter-rouge">'u32'</code>, <code class="language-plaintext highlighter-rouge">'i32'</code>, <code class="language-plaintext highlighter-rouge">'u64'</code>): <code class="language-plaintext highlighter-rouge">'xor-beef'</code>, <code class="language-plaintext highlighter-rouge">'randomizeAbsUnder1024'</code>, <code class="language-plaintext highlighter-rouge">'constant'</code>, <code class="language-plaintext highlighter-rouge">'bitreverse'</code>, <code class="language-plaintext highlighter-rouge">'randomBytes'</code>, <code class="language-plaintext highlighter-rouge">'fisher-yates'</code>.</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">storeCPUBackup</code></strong>: <code class="language-plaintext highlighter-rouge">boolean</code> - If <code class="language-plaintext highlighter-rouge">true</code>, a backup of the initialized CPU buffer is saved for later (this is useful if the primitive overwrites the buffer contents but we still need the original contents, for instance if we are validating the output).</li>
  <li><strong><code class="language-plaintext highlighter-rouge">createGPUBuffer</code></strong>: <code class="language-plaintext highlighter-rouge">boolean</code> - If <code class="language-plaintext highlighter-rouge">true</code>, the corresponding <code class="language-plaintext highlighter-rouge">GPUBuffer</code> is created on the GPU.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">initializeGPUBuffer</code></strong>: <code class="language-plaintext highlighter-rouge">boolean</code> - If <code class="language-plaintext highlighter-rouge">true</code>, data from the CPU buffer is immediately copied to the GPU buffer. Requires <code class="language-plaintext highlighter-rouge">createCPUBuffer</code> to be <code class="language-plaintext highlighter-rouge">true</code>.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">createMappableGPUBuffer</code></strong>: <code class="language-plaintext highlighter-rouge">boolean</code> - If <code class="language-plaintext highlighter-rouge">true</code>, a secondary, mappable GPU buffer is also created to help read data back from the GPU.</li>
</ul>

<hr />

<h2 id="methods">Methods</h2>

<h3 id="createcpubufferargs"><code class="language-plaintext highlighter-rouge">createCPUBuffer(args)</code></h3>

<p>Creates and optionally initializes the CPU-side <code class="language-plaintext highlighter-rouge">TypedArray</code> buffer. You can call this after construction if the buffer wasn’t created in the constructor.</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">args</code></strong>: <code class="language-plaintext highlighter-rouge">object</code> - An optional object to override the instance’s <strong><code class="language-plaintext highlighter-rouge">length</code></strong> and <strong><code class="language-plaintext highlighter-rouge">datatype</code></strong> or provide initialization options.</li>
</ul>

<h3 id="creategpubufferargs"><code class="language-plaintext highlighter-rouge">createGPUBuffer(args)</code></h3>

<p>Creates the <code class="language-plaintext highlighter-rouge">GPUBuffer</code> on the device. You can call this after construction if the GPU buffer wasn’t created in the constructor.</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">args</code></strong>: <code class="language-plaintext highlighter-rouge">object</code> - An optional object to override the instance’s <strong><code class="language-plaintext highlighter-rouge">device</code></strong>, <strong><code class="language-plaintext highlighter-rouge">size</code></strong>, <strong><code class="language-plaintext highlighter-rouge">datatype</code></strong>, or <strong><code class="language-plaintext highlighter-rouge">usage</code></strong>.</li>
</ul>

<h3 id="createmappablegpubuffersize"><code class="language-plaintext highlighter-rouge">createMappableGPUBuffer(size)</code></h3>

<p>Creates a separate GPU buffer that can be mapped by the CPU. This buffer is used as a temporary staging area for transferring data from the main GPU buffer back to the CPU.</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">size</code></strong>: <code class="language-plaintext highlighter-rouge">number</code> - The size in bytes for the mappable buffer.</li>
</ul>

<h3 id="copycputogpu"><code class="language-plaintext highlighter-rouge">copyCPUToGPU()</code></h3>

<p>Uploads data from the CPU-side buffer (<code class="language-plaintext highlighter-rouge">cpuBuffer</code>) to the main GPU buffer.</p>

<h3 id="async-copygputocpu"><code class="language-plaintext highlighter-rouge">async copyGPUToCPU()</code></h3>

<p>Asynchronously copies data from the GPU buffer back to the CPU-side buffer. It works by copying the data to a temporary mappable buffer, reading it back to the CPU, and updating the <code class="language-plaintext highlighter-rouge">cpuBuffer</code> property.</p>

<h3 id="copycpubackuptocpu"><code class="language-plaintext highlighter-rouge">copyCPUBackupToCPU()</code></h3>

<p>Restores the <code class="language-plaintext highlighter-rouge">cpuBuffer</code> from the backup that was created during initialization.</p>

<h3 id="destroy"><code class="language-plaintext highlighter-rouge">destroy()</code></h3>

<p>Destroys the associated GPU buffers to free up GPU memory.</p>

<hr />

<h2 id="properties-getters--setters">Properties (Getters &amp; Setters)</h2>

<h3 id="buffer"><code class="language-plaintext highlighter-rouge">buffer</code></h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">get</code></strong>: Returns the GPU buffer as a <code class="language-plaintext highlighter-rouge">GPUBufferBinding</code> object (e.g., <code class="language-plaintext highlighter-rouge">{ buffer: GPUBuffer }</code>).</li>
  <li><strong><code class="language-plaintext highlighter-rouge">set</code></strong>: Sets the internal GPU buffer. Accepts a raw <code class="language-plaintext highlighter-rouge">GPUBuffer</code> or a <code class="language-plaintext highlighter-rouge">GPUBufferBinding</code> object.</li>
</ul>

<h3 id="cpubuffer"><code class="language-plaintext highlighter-rouge">cpuBuffer</code></h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">get</code></strong>: Returns the CPU-side <code class="language-plaintext highlighter-rouge">TypedArray</code> (e.g., <code class="language-plaintext highlighter-rouge">Float32Array</code>, <code class="language-plaintext highlighter-rouge">Uint32Array</code>).</li>
</ul>

<h3 id="cpubufferbackup"><code class="language-plaintext highlighter-rouge">cpuBufferBackup</code></h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">get</code></strong>: Returns the backup <code class="language-plaintext highlighter-rouge">TypedArray</code> if one was created.</li>
</ul>

<h3 id="size"><code class="language-plaintext highlighter-rouge">size</code></h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">get</code></strong>: Returns the size of the buffer in <strong>bytes</strong>.</li>
</ul>

<h3 id="length"><code class="language-plaintext highlighter-rouge">length</code></h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">get</code></strong>: Returns the number of <strong>elements</strong> in the buffer.</li>
</ul>

<h3 id="device"><code class="language-plaintext highlighter-rouge">device</code></h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">get</code></strong>: Returns the associated <code class="language-plaintext highlighter-rouge">GPUDevice</code>.</li>
</ul>

  </div>

  <a class="u-url" href="/gridwise/docs/2025/09/16/buffer/" hidden></a>
</article>

      </div>
    </main><link id="fa-stylesheet" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css">

<footer class="site-footer h-card">
  <data class="u-url" value="/gridwise/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
      </div>
      <div class="footer-col">
        <p>WebGPU compute primitives in JavaScript</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list">
  <li>
    <a href="http://localhost:4000/gridwise/feed.xml" target="_blank" title="Subscribe to syndication feed">
      <svg class="svg-icon grey" viewbox="0 0 16 16">
        <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
          11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
          13.806c0-1.21.983-2.195 2.194-2.195zM10.606
          16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
        />
      </svg>
    </a>
  </li>
</ul>
</div>

  </div>

</footer>

</body>

</html>
