<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Gridwise WebGPU Object Caching Strategy | Gridwise</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Gridwise WebGPU Object Caching Strategy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn about Gridwise’s caching strategy for WebGPU objects to improve performance while balancing overhead costs." />
<meta property="og:description" content="Learn about Gridwise’s caching strategy for WebGPU objects to improve performance while balancing overhead costs." />
<link rel="canonical" href="http://localhost:4000/gridwise/docs/2025/08/12/webgpu-object-caching-strategy/" />
<meta property="og:url" content="http://localhost:4000/gridwise/docs/2025/08/12/webgpu-object-caching-strategy/" />
<meta property="og:site_name" content="Gridwise" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-08-12T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gridwise WebGPU Object Caching Strategy" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-08-12T00:00:00-04:00","datePublished":"2025-08-12T00:00:00-04:00","description":"Learn about Gridwise’s caching strategy for WebGPU objects to improve performance while balancing overhead costs.","headline":"Gridwise WebGPU Object Caching Strategy","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/gridwise/docs/2025/08/12/webgpu-object-caching-strategy/"},"url":"http://localhost:4000/gridwise/docs/2025/08/12/webgpu-object-caching-strategy/"}</script>
<!-- End Jekyll SEO tag -->
<link id="main-stylesheet" rel="stylesheet" href="/gridwise/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/gridwise/feed.xml" title="Gridwise" />
</head>
<body><header class="site-header">

  <div class="wrapper">
    <a class="site-title" rel="author" href="/gridwise/">Gridwise</a>
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon"></span>
        </label>

        <div class="nav-items">
  <a class="nav-item" href="/gridwise/about/">About</a>
  <a class="nav-item" href="/gridwise/gridwise/architecture/">Gridwise Architecture</a>
  <a class="nav-item" href="/gridwise/gridwise/binop/">Gridwise&#39;s Binary Operator Class</a>
  <a class="nav-item" href="/gridwise/gridwise/buffer/">Gridwise&#39;s Buffer Class</a>
  <a class="nav-item" href="/gridwise/gridwise/builtins-strategy/">Gridwise WebGPU @builtins Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/">Gridwise</a>
  <a class="nav-item" href="/gridwise/gridwise/primitive-design/">Gridwise WebGPU Primitive Strategy wrt Subgroups</a>
  <a class="nav-item" href="/gridwise/gridwise/scan-and-reduce/">Gridwise Scan and Reduce</a>
  <a class="nav-item" href="/gridwise/gridwise/sort/">Gridwise Sort</a>
  <a class="nav-item" href="/gridwise/gridwise/subgroup-strategy/">Gridwise WebGPU Subgroup Emulation Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/timing-strategy/">Gridwise WebGPU Timing Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/webgpu-object-caching-strategy/">Gridwise WebGPU Object Caching Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/writing-a-webgpu-wgsl-workgroup-reduce-function/">Abstraction Challenges in Writing a WebGPU/WGSL Workgroup Reduce Function</a>
</div>

      </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Gridwise WebGPU Object Caching Strategy</h1>
    <div class="post-meta">
      <time class="dt-published" datetime="2025-08-12T00:00:00-04:00" itemprop="datePublished">
        Aug 12, 2025
      </time>
    </div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="gridwise-webgpu-object-caching-strategy">Gridwise WebGPU Object Caching Strategy</h2>

<p>This document outlines the caching strategy used for WebGPU objects within Gridwise. Creating WebGPU objects is not free and is potentially expensive. Caching created objects so that they can be reused potentially helps performance. The downsides of caching are that caching itself is not free and that the WebGPU back end may do its own caching. In Gridwise, caching is enabled by default but can be disabled (by instantiating a primitive with the argument <code class="language-plaintext highlighter-rouge">webgpucache = "disabled"</code>).</p>

<h3 id="cacheable-webgpu-objects">Cacheable WebGPU Objects</h3>

<p>The following WebGPU objects are currently cached by our library:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">GPUShaderModule</code></li>
  <li><code class="language-plaintext highlighter-rouge">GPUPipelineLayout</code></li>
  <li><code class="language-plaintext highlighter-rouge">GPUBindGroupLayout</code></li>
  <li><code class="language-plaintext highlighter-rouge">GPUComputePipeline</code></li>
</ul>

<p>Of these, <code class="language-plaintext highlighter-rouge">GPUShaderModule</code> is potentially independent of the <code class="language-plaintext highlighter-rouge">GPUDevice</code>, while the others are dependent on the specific <code class="language-plaintext highlighter-rouge">GPUDevice</code> instance.</p>

<h2 id="cache-implementation">Cache Implementation</h2>

<p>Every primitive shares a <code class="language-plaintext highlighter-rouge">\_\_deviceToWebGPUObjectCache</code>, which is a <code class="language-plaintext highlighter-rouge">WeakMap</code> that maps a <code class="language-plaintext highlighter-rouge">GPUDevice</code> to its corresponding cache. Each device’s cache contains several individual caches for different object types. These are regular <code class="language-plaintext highlighter-rouge">Map</code> objects that map a generated key to the WebGPU object.</p>

<p>The available caches are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pipelineLayouts</code></li>
  <li><code class="language-plaintext highlighter-rouge">bindGroupLayouts</code></li>
  <li><code class="language-plaintext highlighter-rouge">computeModules</code></li>
  <li><code class="language-plaintext highlighter-rouge">computePipelines</code></li>
</ul>

<p>Each of these caches can be individually enabled or disabled when a primitive is created.</p>

<p>Here is a simplified code representation of the cache structure:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">BasePrimitive</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="nx">__deviceToWebGPUObjectCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">WeakMap</span><span class="p">();</span>
  <span class="c1">// ... inside a method ...</span>
  <span class="nx">BasePrimitive</span><span class="p">.</span><span class="nx">__deviceToWebGPUObjectCache</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">WebGPUObjectCache</span><span class="p">()</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">WebGPUObjectCache</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">caches</span> <span class="o">=</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">pipelineLayouts</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">bindGroupLayouts</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">computeModules</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">computePipelines</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">cache</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">caches</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">[</span><span class="nx">cache</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CountingMap</span><span class="p">({</span> <span class="c1">// wrapper over a Map</span>
        <span class="na">enabled</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">initiallyEnabled</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">cache</span><span class="p">),</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="bind-group-caching">Bind Group Caching</h3>

<p>Bind groups are not cached. This decision was made because bind groups depend on <code class="language-plaintext highlighter-rouge">GPUBuffer</code> objects. Reliably creating a cache key from a
<code class="language-plaintext highlighter-rouge">GPUBuffer</code> is problematic due to its dynamic state.</p>

<h3 id="cache-key-generation">Cache Key Generation</h3>

<p>To use objects as keys in a Map, we need a consistent and unique representation. Since Maps use Same-Value-Zero equality, two different objects with the same properties will not be treated as the same key. To solve this, we <code class="language-plaintext highlighter-rouge">JSON.stringify</code> a simplified representation of the object to create a string-based cache key.</p>

<p>Here’s how keys are generated for different object types:</p>

<h4 id="pipeline-layout">Pipeline Layout</h4>

<p>The cache key for a <code class="language-plaintext highlighter-rouge">GPUPipelineLayout</code> is an array of strings representing the buffer types for that layout.</p>

<p>Example:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="dl">"</span><span class="s2">read-only-storage</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">storage</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">uniform</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">storage</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">storage</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">storage</span><span class="dl">"</span><span class="p">];</span>
</code></pre></div></div>

<h4 id="bind-group-layout">Bind Group Layout</h4>

<p>The cache key for a <code class="language-plaintext highlighter-rouge">GPUBindGroupLayout</code> is the set of entries for that layout.</p>

<p>Example:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="p">{</span> <span class="na">binding</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">visibility</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="na">buffer</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">read-only-storage</span><span class="dl">"</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">binding</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">visibility</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="na">buffer</span><span class="p">:</span> <span class="p">{</span>
      <span class="cm">/*...*/</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="c1">// ... and so on for all entries</span>
<span class="p">];</span>
</code></pre></div></div>

<h4 id="compute-module">Compute Module</h4>

<p>The cache key for a <code class="language-plaintext highlighter-rouge">GPUShaderModule</code> (referred to as a compute module in the context of compute shaders) is the entire kernel string. While underlying WebGPU engines like Dawn might have their own caching mechanisms, we implement a library-level cache for them as well.</p>

<h4 id="compute-pipelines">Compute Pipelines</h4>

<p>The cache key for a <code class="language-plaintext highlighter-rouge">GPUComputePipeline</code> is derived from its descriptor object. Since the <code class="language-plaintext highlighter-rouge">GPUPipelineLayout</code> and <code class="language-plaintext highlighter-rouge">GPUShaderModule</code> are cached separately, we can reuse their cache keys to optimize the key generation for the pipeline itself.</p>

<p>A <code class="language-plaintext highlighter-rouge">__cacheKey</code> property is stored on cacheable objects, and this key is used during stringification to avoid deep, recursive serialization.</p>

<h3 id="cache-statistics">Cache Statistics</h3>

<p>The caches collect hit and miss statistics to help understand their effectiveness.</p>

<p>Example output from statistics collection:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cache hits/misses:
Pipeline layouts: 7/1
Bind group layouts: 0/1
Compute modules: 4/4
Compute pipelines: 4/4
</code></pre></div></div>

<h3 id="measuring-performance-with-cpu-timing">Measuring Performance with CPU Timing</h3>

<p>To measure the performance impact of caching, enable CPU timing. This will wait for the GPU to finish its work and then record the CPU time taken.</p>

<p>(TODO: move this into the timing article)</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">commandBuffer</span> <span class="o">=</span> <span class="nx">encoder</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">?.</span><span class="nx">enableCPUTiming</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">onSubmittedWorkDone</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cpuStartTime</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">submit</span><span class="p">([</span><span class="nx">commandBuffer</span><span class="p">]);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">?.</span><span class="nx">enableCPUTiming</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">onSubmittedWorkDone</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cpuEndTime</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

  </div>

  <a class="u-url" href="/gridwise/docs/2025/08/12/webgpu-object-caching-strategy/" hidden></a>
</article>

      </div>
    </main><link id="fa-stylesheet" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css">

<footer class="site-footer h-card">
  <data class="u-url" value="/gridwise/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
      </div>
      <div class="footer-col">
        <p>WebGPU compute primitives in JavaScript</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list">
  <li>
    <a href="http://localhost:4000/gridwise/feed.xml" target="_blank" title="Subscribe to syndication feed">
      <svg class="svg-icon grey" viewbox="0 0 16 16">
        <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
          11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
          13.806c0-1.21.983-2.195 2.194-2.195zM10.606
          16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
        />
      </svg>
    </a>
  </li>
</ul>
</div>

  </div>

</footer>

</body>

</html>
