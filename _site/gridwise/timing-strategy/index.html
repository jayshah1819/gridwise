<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Gridwise WebGPU Timing Strategy | Gridwise</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Gridwise WebGPU Timing Strategy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CPU and GPU timing methodologies for measuring and optimizing WebGPU primitive performance in Gridwise." />
<meta property="og:description" content="CPU and GPU timing methodologies for measuring and optimizing WebGPU primitive performance in Gridwise." />
<link rel="canonical" href="http://localhost:4000/gridwise/gridwise/timing-strategy/" />
<meta property="og:url" content="http://localhost:4000/gridwise/gridwise/timing-strategy/" />
<meta property="og:site_name" content="Gridwise" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gridwise WebGPU Timing Strategy" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"CPU and GPU timing methodologies for measuring and optimizing WebGPU primitive performance in Gridwise.","headline":"Gridwise WebGPU Timing Strategy","url":"http://localhost:4000/gridwise/gridwise/timing-strategy/"}</script>
<!-- End Jekyll SEO tag -->
<link id="main-stylesheet" rel="stylesheet" href="/gridwise/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/gridwise/feed.xml" title="Gridwise" />
</head>
<body><header class="site-header">

  <div class="wrapper">
    <a class="site-title" rel="author" href="/gridwise/">Gridwise</a>
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon"></span>
        </label>

        <div class="nav-items">
  <a class="nav-item" href="/gridwise/about/">About</a>
  <a class="nav-item" href="/gridwise/gridwise/architecture/">Gridwise Architecture</a>
  <a class="nav-item" href="/gridwise/gridwise/binop/">Gridwise&#39;s Binary Operator Class</a>
  <a class="nav-item" href="/gridwise/gridwise/buffer/">Gridwise&#39;s Buffer Class</a>
  <a class="nav-item" href="/gridwise/gridwise/builtins-strategy/">Gridwise WebGPU @builtins Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/">Gridwise</a>
  <a class="nav-item" href="/gridwise/gridwise/primitive-design/">Gridwise WebGPU Primitive Strategy wrt Subgroups</a>
  <a class="nav-item" href="/gridwise/gridwise/scan-and-reduce/">Gridwise Scan and Reduce</a>
  <a class="nav-item" href="/gridwise/gridwise/sort/">Gridwise Sort</a>
  <a class="nav-item" href="/gridwise/gridwise/subgroup-strategy/">Gridwise WebGPU Subgroup Emulation Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/timing-strategy/">Gridwise WebGPU Timing Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/webgpu-object-caching-strategy/">Gridwise WebGPU Object Caching Strategy</a>
  <a class="nav-item" href="/gridwise/gridwise/writing-a-webgpu-wgsl-workgroup-reduce-function/">Abstraction Challenges in Writing a WebGPU/WGSL Workgroup Reduce Function</a>
</div>

      </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Gridwise WebGPU Timing Strategy</h1>
  </header>

  <div class="post-content">
    <p>Building a high-performance WebGPU primitive library requires careful timing measurements to ensure that primitives deliver high performance to their users. In developing Gridwise, we designed both CPU and GPU timing methodologies and describe them here.</p>

<h2 id="gpu-timing">GPU Timing</h2>

<p>Gridwise’s GPU timing uses WebGPU’s GPU timestamp queries. Gregg Tavares’s “<a href="https://webgpufundamentals.org/webgpu/lessons/webgpu-timing.html">WebGPU Timing Performance
</a>” is both an excellent overview of using timestamp queries as well as the basis for our implementation. We began with his <a href="https://webgpufundamentals.org/webgpu/lessons/webgpu-timing.html#a-timing-helper">timing helper</a> and augmented it to support calling multiple kernels (which is useful for benchmarking purposes).</p>

<p>In our implementation, the <code class="language-plaintext highlighter-rouge">Primitive</code> class has a static <code class="language-plaintext highlighter-rouge">__timingHelper</code> member that is initialized to understand. The timing helper is enabled by passing <code class="language-plaintext highlighter-rouge">enableGPUTiming: true</code> as a member of the argument object to <code class="language-plaintext highlighter-rouge">primitive.execute()</code> (i.e., <code class="language-plaintext highlighter-rouge">primitive.execute{ enableGPUTiming: true, ...}</code>).</p>

<p>When GPU timing is enabled in this way, <code class="language-plaintext highlighter-rouge">primitive.execute</code> checks for a defined <code class="language-plaintext highlighter-rouge">__timingHelper</code> and initializes one if not, counting the number of kernels in the current primitive for the timing helper’s initialization. As explained by the <a href="https://webgpufundamentals.org/webgpu/lessons/webgpu-timing.html#a-timing-helper">timing helper</a>’s documentation, the timing helper replaces <code class="language-plaintext highlighter-rouge">beginComputePass</code> with its own <code class="language-plaintext highlighter-rouge">beginComputePass</code> that initializes the timing helper.</p>

<p>We record a separate timing value for each kernel in the primitive and thus return a list of kernel time durations, one list element per kernel.</p>

<p><code class="language-plaintext highlighter-rouge">primitive.execute</code>’s argument object also takes a <code class="language-plaintext highlighter-rouge">trials</code> argument that defaults to 1. If <code class="language-plaintext highlighter-rouge">trials</code> is <em>n</em>, then every kernel dispatch within the primitive is replaced with <em>n</em> consecutive dispatches. Running more trials is helpful for more reliable timing measurements.</p>

<h2 id="cpu-timing">CPU timing</h2>

<p>CPU timing is only possible if the primitive creates its own encoder to ensure that the resulting command buffer only reflects the work within the primitive. It is enabled in a similar way to GPU timing (<code class="language-plaintext highlighter-rouge">primitive.execute{ enableCPUTiming: true, ...}</code>). In our internal discussions, we have settled on the following way to best measure CPU timing, which is what is implemented within Gridwise, but we are open to better suggestions here. Our strategy is to clear the device’s queue, record the current time as <code class="language-plaintext highlighter-rouge">cpuStartTime</code>, submit the command buffer and wait for the queue to clear, then record the current time as <code class="language-plaintext highlighter-rouge">gpuStartTime</code>. The elapsed time is the time between the two CPU time stamps.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">commandBuffer</span> <span class="o">=</span> <span class="nx">encoder</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">?.</span><span class="nx">enableCPUTiming</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">onSubmittedWorkDone</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cpuStartTime</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">submit</span><span class="p">([</span><span class="nx">commandBuffer</span><span class="p">]);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">?.</span><span class="nx">enableCPUTiming</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">onSubmittedWorkDone</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cpuEndTime</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="returning-timing-information">Returning timing information</h2>

<p>The primitive object has a <code class="language-plaintext highlighter-rouge">async getTimingResult</code> member function that returns the CPU and GPU timing result as <code class="language-plaintext highlighter-rouge">const { gpuTotalTimeNS, cpuTotalTimeNS } = await primitive.getTimingResult();</code>. For GPU timing, this call returns a list of total elapsed times per kernel in ns. For CPU timing, this call returns an elapsed time for the entire primitive in ns. Neither accounts for <code class="language-plaintext highlighter-rouge">trials</code>, so the caller of <code class="language-plaintext highlighter-rouge">getTimingResult</code> should divide any returned values by the number of trials.</p>

  </div>

</article>

      </div>
    </main><link id="fa-stylesheet" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css">

<footer class="site-footer h-card">
  <data class="u-url" value="/gridwise/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
      </div>
      <div class="footer-col">
        <p>WebGPU compute primitives in JavaScript</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list">
  <li>
    <a href="http://localhost:4000/gridwise/feed.xml" target="_blank" title="Subscribe to syndication feed">
      <svg class="svg-icon grey" viewbox="0 0 16 16">
        <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
          11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
          13.806c0-1.21.983-2.195 2.194-2.195zM10.606
          16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
        />
      </svg>
    </a>
  </li>
</ul>
</div>

  </div>

</footer>

</body>

</html>
