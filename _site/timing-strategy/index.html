<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Gridwise WebGPU Timing Strategy | Gridwise</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Gridwise WebGPU Timing Strategy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CPU and GPU timing methodologies for measuring and optimizing WebGPU primitive performance in Gridwise." />
<meta property="og:description" content="CPU and GPU timing methodologies for measuring and optimizing WebGPU primitive performance in Gridwise." />
<link rel="canonical" href="http://localhost:4000/gridwise/timing-strategy/" />
<meta property="og:url" content="http://localhost:4000/gridwise/timing-strategy/" />
<meta property="og:site_name" content="Gridwise" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gridwise WebGPU Timing Strategy" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"CPU and GPU timing methodologies for measuring and optimizing WebGPU primitive performance in Gridwise.","headline":"Gridwise WebGPU Timing Strategy","url":"http://localhost:4000/gridwise/timing-strategy/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/gridwise/docs/assets/css/style.css"></head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/gridwise/%20/">Gridwise</a><nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.484C18,14.304,17.335,14.969,16.516,14.969H1.484 C0.665,14.969,0,14.304,0,13.484l0,0C0,12.665,0.665,12,1.484,12h15.032C17.335,12,18,12.665,18,13.484L18,13.484z" />
          </svg>
        </span>
      </label>

      <div class="trigger"><a class="button" href="/gridwise/%20/examples-guide/">Example Docs</a>
        <a class="button" href="/gridwise/%20/">Read Docs</a>
        <a class="button" href="javascript:void(0)" onclick="launchExample()">Try Interactive Example</a>
      </div>
    </nav></div>
</header>

<script>
  function launchExample() {
    window.open('https://gridwise-webgpu.github.io/gridwise/examples/scan_pane_example.html', '_blank');
  }
</script><main class="page-content" aria-label="Content">
  <div class="wrapper">
    <div class="docs-container">
    <!-- Left Sidebar Navigation -->
    <aside class="docs-sidebar">
        <h3>Documentation</h3><ul class="docs-nav"><li>
                <a href="/gridwise/architecture/" >
                    Gridwise Architecture
                </a>
            </li><li>
                <a href="/gridwise/buffer/" >
                    Gridwise&#39;s Buffer Class
                </a>
            </li><li>
                <a href="/gridwise/binop/" >
                    Gridwise&#39;s Binary Operator Class
                </a>
            </li><li>
                <a href="/gridwise/scan-and-reduce/" >
                    Gridwise Scan and Reduce
                </a>
            </li><li>
                <a href="/gridwise/sort/" >
                    Gridwise Sort
                </a>
            </li><li>
                <a href="/gridwise/builtins-strategy/" >
                    Gridwise WebGPU @builtins Strategy
                </a>
            </li><li>
                <a href="/gridwise/primitive-design/" >
                    Gridwise WebGPU Primitive Strategy wrt Subgroups
                </a>
            </li><li>
                <a href="/gridwise/subgroup-strategy/" >
                    Gridwise WebGPU Subgroup Emulation Strategy
                </a>
            </li><li>
                <a href="/gridwise/webgpu-object-caching-strategy/" >
                    Gridwise WebGPU Object Caching Strategy
                </a>
            </li><li>
                <a href="/gridwise/timing-strategy/" class="active" >
                    Gridwise WebGPU Timing Strategy
                </a>
            </li><li>
                <a href="/gridwise/writing-a-webgpu-wgsl-workgroup-reduce-function/" >
                    Abstraction Challenges in Writing a WebGPU/WGSL Workgroup Reduce Function
                </a>
            </li></ul><!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <a href="https://github.com/gridwise-webgpu/gridwise" target="_blank" class="github-link">
                <svg class="github-icon" viewBox="0 0 16 16" width="20" height="20">
                    <path fill="currentColor"
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                    </path>
                </svg>
                <span>GitHub</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="docs-content">
        <article class="post">
            <header class="post-header">
                <h1 class="post-title">Gridwise WebGPU Timing Strategy</h1>
            </header>

            <div class="post-content">
                <p>Building a high-performance WebGPU primitive library requires careful timing measurements to ensure that primitives deliver high performance to their users. In developing Gridwise, we designed both CPU and GPU timing methodologies and describe them here.</p>

<h2 id="gpu-timing">GPU Timing</h2>

<p>Gridwise’s GPU timing uses WebGPU’s GPU timestamp queries. Gregg Tavares’s “<a href="https://webgpufundamentals.org/webgpu/lessons/webgpu-timing.html">WebGPU Timing Performance
</a>” is both an excellent overview of using timestamp queries as well as the basis for our implementation. We began with his <a href="https://webgpufundamentals.org/webgpu/lessons/webgpu-timing.html#a-timing-helper">timing helper</a> and augmented it to support calling multiple kernels (which is useful for benchmarking purposes).</p>

<p>In our implementation, the <code class="language-plaintext highlighter-rouge">Primitive</code> class has a static <code class="language-plaintext highlighter-rouge">__timingHelper</code> member that is initialized to understand. The timing helper is enabled by passing <code class="language-plaintext highlighter-rouge">enableGPUTiming: true</code> as a member of the argument object to <code class="language-plaintext highlighter-rouge">primitive.execute()</code> (i.e., <code class="language-plaintext highlighter-rouge">primitive.execute{ enableGPUTiming: true, ...}</code>).</p>

<p>When GPU timing is enabled in this way, <code class="language-plaintext highlighter-rouge">primitive.execute</code> checks for a defined <code class="language-plaintext highlighter-rouge">__timingHelper</code> and initializes one if not, counting the number of kernels in the current primitive for the timing helper’s initialization. As explained by the <a href="https://webgpufundamentals.org/webgpu/lessons/webgpu-timing.html#a-timing-helper">timing helper</a>’s documentation, the timing helper replaces <code class="language-plaintext highlighter-rouge">beginComputePass</code> with its own <code class="language-plaintext highlighter-rouge">beginComputePass</code> that initializes the timing helper.</p>

<p>We record a separate timing value for each kernel in the primitive and thus return a list of kernel time durations, one list element per kernel.</p>

<p><code class="language-plaintext highlighter-rouge">primitive.execute</code>’s argument object also takes a <code class="language-plaintext highlighter-rouge">trials</code> argument that defaults to 1. If <code class="language-plaintext highlighter-rouge">trials</code> is <em>n</em>, then every kernel dispatch within the primitive is replaced with <em>n</em> consecutive dispatches. Running more trials is helpful for more reliable timing measurements.</p>

<h2 id="cpu-timing">CPU timing</h2>

<p>CPU timing is only possible if the primitive creates its own encoder to ensure that the resulting command buffer only reflects the work within the primitive. It is enabled in a similar way to GPU timing (<code class="language-plaintext highlighter-rouge">primitive.execute{ enableCPUTiming: true, ...}</code>). In our internal discussions, we have settled on the following way to best measure CPU timing, which is what is implemented within Gridwise, but we are open to better suggestions here. Our strategy is to clear the device’s queue, record the current time as <code class="language-plaintext highlighter-rouge">cpuStartTime</code>, submit the command buffer and wait for the queue to clear, then record the current time as <code class="language-plaintext highlighter-rouge">gpuStartTime</code>. The elapsed time is the time between the two CPU time stamps.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">commandBuffer</span> <span class="o">=</span> <span class="nx">encoder</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">?.</span><span class="nx">enableCPUTiming</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">onSubmittedWorkDone</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cpuStartTime</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">submit</span><span class="p">([</span><span class="nx">commandBuffer</span><span class="p">]);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">?.</span><span class="nx">enableCPUTiming</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">onSubmittedWorkDone</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cpuEndTime</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="returning-timing-information">Returning timing information</h2>

<p>The primitive object has a <code class="language-plaintext highlighter-rouge">async getTimingResult</code> member function that returns the CPU and GPU timing result as <code class="language-plaintext highlighter-rouge">const { gpuTotalTimeNS, cpuTotalTimeNS } = await primitive.getTimingResult();</code>. For GPU timing, this call returns a list of total elapsed times per kernel in ns. For CPU timing, this call returns an elapsed time for the entire primitive in ns. Neither accounts for <code class="language-plaintext highlighter-rouge">trials</code>, so the caller of <code class="language-plaintext highlighter-rouge">getTimingResult</code> should divide any returned values by the number of trials.</p>

            </div>
        </article>
        </main>
</div>

<script>
  // Save and restore sidebar scroll position
  (function() {
    const sidebar = document.querySelector('.docs-sidebar');
    if (!sidebar) return;
    
    // Restore scroll position immediately
    const savedScrollPos = sessionStorage.getItem('sidebarScrollPos');
    if (savedScrollPos) {
      sidebar.scrollTop = parseInt(savedScrollPos);
    }
    
    // Save on scroll
    let scrollTimer;
    sidebar.addEventListener('scroll', function() {
      clearTimeout(scrollTimer);
      scrollTimer = setTimeout(function() {
        sessionStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
      }, 100);
    });
    
    // Save on link click and restore after navigation
    sidebar.querySelectorAll('a').forEach(function(link) {
      link.addEventListener('click', function(e) {
        sessionStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
      });
    });
    
    // Restore again after a short delay to handle any reflows
    window.addEventListener('load', function() {
      if (savedScrollPos) {
        sidebar.scrollTop = parseInt(savedScrollPos);
      }
    });
  })();
</script>

  </div>
</main><footer class="site-footer h-card">
    <data class="u-url" href="/gridwise/%20/"></data>

    <div class="wrapper">
        <h2 class="footer-heading">Gridwise</h2>

        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="contact-list">
                    <li class="p-name">Gridwise</li><li><a class="u-email" href="mailto:jowens@ece.ucdavis.edu">jowens@ece.ucdavis.edu</a></li></ul>
            </div>

            <div class="footer-col footer-col-3">
                <p>WebGPU compute primitives in JavaScript</p>
            </div>
        </div>

    </div>

</footer></body>

</html>
